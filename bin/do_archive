#!/usr/bin/perl
 
$matlabcom = 0;

while ($ARGV[0])
{
  if (($ARGV[0] =~ /\-\-help/) || ($ARGV[0] =~ /\-help/) ||
      ($ARGV[0] =~ /\-\-h/)    || ($ARGV[0] =~ /\-h/)) {
    print "Create an archive from the cvs files of the project\n";
    print " -help, -h : this help\n";
    print " -matlabcom, -m : include Matlab commands\n";
  }
  elsif (($ARGV[0] =~ /\-\-matlabcom/)|| ($ARGV[0] =~ /\-matlabcom/) ||
	 ($ARGV[0] =~ /\-\-m/)    || ($ARGV[0] =~ /\-m/)) {
    $matlabcom = 1;
  }
  else
  { 
    die "Sorry, unrecognized option";
  }
  shift ARGV;
}

#######################################
#      Date identification            #
#######################################

$date = localtime;

($sec, $min, $heure, $mjour, $mois, $annee, $sjour, $ajour, $isdst)=localtime;
$mois += 1; $annee += 1900; $sjour += 1;

print "Doing archive for the date : $mois/$mjour/$annee\n";

`mkdir -p temp`;
`rm -f getfem++-1.0.tar.gz`;

#######################################
#      Loading getfem++               #
#######################################


print "loading getfem++ from cvs\n\n";

print `cd temp; cvs export -D $mois/$mjour/$annee getfem++`; print "\n\n";
`rm -fr temp/getfem++/misc`;
`rm -fr temp/getfem++/gensolv`;
`rm -fr temp/getfem++/archives`;
if (!$matlabcom) {
  `rm -fr temp/getfem++/matlabcom`;
  `rm -fr temp/getfem++/matlabint`;
}

#######################################
#    Structure simplification         #
#######################################

print "Making links\n";
`mkdir -p temp/getfem++/include`;
`mkdir -p temp/getfem++/sources`;

if (-d "temp/getfem++/dal") {
  `cd temp/getfem++/include; cp ../dal/*.h .`;
  `cd temp/getfem++/sources; cp ../dal/*.C .`;
  `rm -fr temp/getfem++/dal`;
}

if (-d "temp/getfem++/bgeot") {
  `cd temp/getfem++/include; cp ../bgeot/*.h .`;
  `cd temp/getfem++/sources; cp ../bgeot/*.C .`; 
  `rm -fr temp/getfem++/bgeot`;
}

if (-d "temp/getfem++/linkmsg") {
  `cd temp/getfem++/include; cp ../linkmsg/*.h .`;
  `rm -fr temp/getfem++/linkmsg`;
}

if (-d "temp/getfem++/ftool") {
  `cd temp/getfem++/include; cp ../ftool/*.h .`;
  `cd temp/getfem++/sources; cp ../ftool/*.C .`;
  `rm -fr temp/getfem++/ftool`;
}

if (-d "temp/getfem++/getfemlib") {
  `cd temp/getfem++/include; cp ../getfemlib/*.h .`;
  `cd temp/getfem++/sources; cp ../getfemlib/*.C .`;
  `rm -fr temp/getfem++/getfemlib`;
}

if (-d "temp/getfem++/misc/LEDAWIN") {
  `cd temp/getfem++/include; cp ../misc/LEDAWIN/*.h .`;
  `cd temp/getfem++/sources; cp ../misc/LEDAWIN/*.C .`;
}

if (-d "temp/getfem++/misc") {
  `cd temp/getfem++/include; cp ../misc/*.h .`;
  `cd temp/getfem++/sources; cp ../misc/*.C .`;
  `rm -fr temp/getfem++/misc`;
}

if (-d "temp/getfem++/matlabint") {
  `cd temp/getfem++/include; cp ../matlabint/*.h .`;
  `cd temp/getfem++/sources; cp ../matlabint/*.C .`;
  `rm -fr temp/getfem++/matlabint`;
}

if (-d "temp/getfem++/gensolv") {
  `cd temp/getfem++/include; cp ../gensolv/*.h .`;
  `rm -fr temp/getfem++/gensolv`;
}

#######################################
#    Creating archive                 #
#######################################

`mv temp/getfem++ temp/getfem++-1.0`;
`cd temp; tar cvf ../getfem++-1.0.tar getfem++-1.0`;
`gzip getfem++-1.0.tar`;
`rm -fr temp`;
